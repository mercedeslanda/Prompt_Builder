<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Prompts UrbanalÃ­tica</title>
  <style>
    body { font-family: sans-serif; margin: 40px; max-width: 800px; }
    select, input[type="text"], textarea { width: 100%; margin-bottom: 12px; padding: 6px; font-size: 1rem; }
    button { margin-top: 10px; padding: 10px; font-size: 1rem; cursor: pointer; }
    .preview-container img { max-width: 120px; margin: 4px; display: inline-block; }
    .selector-block { margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 12px; }
    .add-option { display: flex; margin-top: 6px; }
    .add-option input { flex: 1; margin-right: 6px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>

  <h1>Imaginar el Futuro del Territorio a 25 aÃ±os</h1>
  <p>Generador de Prompts __ URBANALÃTICA</p>

  <!-- Imagen guÃ­a -->
  <label for="iw">ğŸ–¼ï¸ Imagen guÃ­a (<code>--iw</code>)</label>
  <input type="text" id="iw" placeholder="URLs separadas por coma o espacio">
  <div id="preview_iw" class="preview-container"></div>

   <!-- Selectores desde Google Sheets -->
  <div id="selectors"></div>
  
  <!-- Estilo visual -->
  <label for="sref">ğŸ¨ Estilo visual (<code>--sref</code>)</label>
  <input type="text" id="sref" placeholder="URLs separadas por coma o espacio">
  <div id="preview_sref" class="preview-container"></div>

  <!-- Objeto estilo exacto -->
  <label for="oref">ğŸ¨ Objeto estilo exacto (<code>--oref</code>)</label>
  <input type="text" id="oref" placeholder="URLs separadas por coma o espacio">
  <div id="preview_oref" class="preview-container"></div>



  <!-- Moodboards -->
  <label for="moodboard">ğŸ¨ Moodboards (<code>--p</code>)</label>
  <input type="text" id="moodboard" placeholder="--p ejemplo">

  <!-- GeneraciÃ³n y guardado -->
  <button onclick="buildPrompt()">ğŸ” Generar Prompt</button>
  <button onclick="copyAndSavePrompt()">ğŸ“‹ Copiar + Guardar</button>

  <label for="output">Prompt generado (editable):</label>
  <textarea id="output" rows="4" placeholder="Tu prompt..."></textarea>

<script>
// URL al CSV exportado de Google Sheets (publicado como CSV)
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR6s7kqLZw_q-qATqMs1-5oKdDddH2IJ-oXWNSVuT9XUGSQjkwNWPYx-XLv8O1FcVEiEr28ifZ-WDGM/pub?gid=0&single=true&output=csv';
const SHEET_ADD = 'https://script.google.com/macros/s/AKfycbxlWowODLgms93HWLeL8v181a-L3RxM0qcohmoM1vO7FOY8Zqy8e_4Q_g8lOxOIS1BTPg/exec';
const SHEET_SAVE = 'https://script.google.com/macros/library/d/1nsMORaQ4tU2F5qZjZ1rihCVvXpLvwl4IObmx_LUteXASTCvxwT4rJhNk/1';

function normalizeId(text) {
  return text.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
}

function addOption(header, value) {
  if (!value) return;
  fetch(SHEET_ADD, {
    method: 'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({header, value})
  });
}

function buildSelectors(data) {
  const container = document.getElementById('selectors');
  container.innerHTML='';
  Object.keys(data).forEach(header => {
    const id = normalizeId(header);
    const block = document.createElement('div'); block.className='selector-block';
    block.innerHTML = `
      <label for="${id}">${header}</label>
      <select id="${id}" multiple></select>
      <div class="add-option">
        <input type="text" id="new_${id}" placeholder="Agregar a ${header}">
        <button onclick="addOption('${header}', document.getElementById('new_${id}').value)">+ AÃ±adir</button>
      </div>
    `;
    container.appendChild(block);
    const sel = block.querySelector('select');
    data[header].forEach(val => {
      const opt = document.createElement('option'); opt.value=val; opt.innerText=val;
      sel.appendChild(opt);
    });
  });
}

function setupPreview(id) {
  const inp=document.getElementById(id), cont=document.getElementById('preview_'+id);
  inp.addEventListener('input',()=>{
    cont.innerHTML='';
    inp.value.split(/[,\s]+/).filter(u=>u).forEach(u=>{
      const img=document.createElement('img'); img.src=u; img.onerror=()=>img.remove();
      cont.appendChild(img);
    });
  });
}

function buildPrompt() {
  const parts=[];
  ['iw'].forEach(id=>document.getElementById(id).value.split(/[,\s]+/).filter(u=>u).forEach(u=>parts.push(u)));
  document.querySelectorAll('#selectors select').forEach(sel=>{
    Array.from(sel.selectedOptions).forEach(o=>parts.push(o.value));
  });
  const mood=document.getElementById('moodboard').value; if(mood) parts.push(mood);
  document.getElementById('output').value=parts.join(' ');
}

function copyAndSavePrompt(){
  const t=document.getElementById('output').value;
  navigator.clipboard.writeText(t);
  fetch(SHEET_SAVE, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:t})});
  alert('âœ… Copiado y guardado');
}

// Inits: auto-setup previews for any input that has a preview container
    document.querySelectorAll('.preview-container').forEach(cont => {
      const id = cont.id.replace('preview_','');
      setupPreview(id);
    });

    Papa.parse(CSV_URL, {(CSV_URL, {
  download: true, header: true, skipEmptyLines: true,
  complete: res => {
    const data = {};
    res.meta.fields.forEach(h=>data[h]=[]);
    res.data.forEach(row=>res.meta.fields.forEach(h=>{
      const v=row[h]; if(v && !data[h].includes(v)) data[h].push(v);
    }));
    buildSelectors(data);
  }
});
</script>
</body>
</html>
