<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Prompts Urbanal√≠tica</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 40px auto;
      max-width: 800px;
      text-align: center;
      color: #ff00ff;
    }
    select, input[type="text"], textarea {
      display: block;
      margin-left: auto;
      margin-right: auto;
      width: 100%;
      margin-bottom: 12px;
      padding: 8px;
      font-size: 1rem;
      border: 1px solid #ccc;
      box-sizing: border-box;
      color: #000;
    }
    #selectors label, label[for="params"] {
      display: block;
      font-weight: bold;
      text-transform: uppercase;
      margin: 20px 0 4px;
    }
    #selectors select, #params {
      height: 200px;
      overflow-y: auto;
      background-color: white;
    }
    button {
      margin-top: 12px;
      padding: 10px 16px;
      font-size: 1rem;
      cursor: pointer;
    }
    .add-btn {
      display: inline-block;
      font-size: 0.85rem;
      margin-bottom: 8px;
      color: #0066cc;
      background: none;
      border: none;
      text-decoration: underline;
      cursor: pointer;
    }
    .new-option-input-wrapper {
      display: none;
      margin-top: 4px;
    }
    h2#output {
      margin-top: 30px;
      font-weight: bold;
      background: transparent;
      padding: 20px;
      border: 1px solid #ccc;
      font-size: 1.2rem;
      white-space: pre-wrap;
      color: #ff00ff;
    }
    .preview-container img {
      max-width: 120px;
      margin: 4px;
      display: inline-block;
    }
    hr {
      margin: 24px 0;
      border: none;
      border-top: 1px solid #eee;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <p>Generador de Prompts ‚Äì URBANAL√çTICA</p>
  <p>Selecciona m√∫ltiples opciones por categor√≠a (Ctrl/Cmd + clic):</p>

  <label for="iw">üñºÔ∏è Imagen gu√≠a (<code>--iw</code>)</label>
  <input type="text" id="iw" placeholder="Pega enlace de imagen">
  <div id="preview_iw" class="preview-container"></div>

  <hr>

  <div id="selectors"></div>

  <hr>

  <label for="sref">üé® Estilo visual (<code>--sref</code>)</label>
  <input type="text" id="sref" placeholder="Pega enlace de estilo visual">
  <div id="preview_sref" class="preview-container"></div>

  <label for="oref">üé® Objeto y estilo exactos (<code>--oref</code>)</label>
  <input type="text" id="oref" placeholder="Pega enlace de objeto/estilo exacto">
  <div id="preview_oref" class="preview-container"></div>

  <label for="moodboard">üé≠ Moodboards (<code>--p</code>)</label>
  <input type="text" id="moodboard" placeholder="--p <ID moodboard>">

  <hr>

  <label for="params">‚öôÔ∏è Par√°metros Midjourney</label>
  <select id="params" multiple>
    <option value="--ar 16:9">--ar 16:9 (aspect ratio horizontal)</option>
    <option value="--style raw">--style raw (sin extras)</option>
    <option value="--stylize 550">--stylize 550 (estilizaci√≥n media)</option>
    <option value="--repeat 1">--repeat 1 (ahorra tiempo)</option>
    <option value="--seed 123">--seed 123 (series consistentes)</option>
    <option value="--weird 0">--weird 0 (m√°s serio)</option>
    <option value="--weird 1000">--weird 1000 (m√°s extra√±o)</option>
    <option value="--chaos 50">--chaos 50 (varianza en iteraci√≥n)</option>
    <option value="--tile">--tile (mosaico)</option>
    <option value="--stop 100">--stop 100 (detener antes)</option>
    <option value="--quality 2">--quality 2 (calidad alta)</option>
    <option value="--hd">--hd (alta resoluci√≥n)</option>
  </select>

  <button onclick="buildPrompt()">üîÅ Generar Prompt</button>
  <button onclick="copyPromptAndSaveToSeparateSheet()">üìã Copiar Prompt</button>

  <h2 id="output">Prompt generado aparecer√° aqu√≠‚Ä¶</h2>
  <textarea id="outputText" rows="4" placeholder="Aqu√≠ aparece tu prompt..."></textarea>

<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbxwMHRgFpka3zZJhxRceIW6ycxCK4cCDD36qCTPya3GWLVU3mJ2XH1-A3xHFPNCRfI4/exec';

  Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vR6s7kqLZw_q-qATqMs1-5oKdDddH2IJ-oXWNSVuT9XUGSQjkwNWPYx-XLv8O1FcVEiEr28ifZ-WDGM/pub?gid=0&single=true&output=csv', {
    download: true,
    header: true,
    skipEmptyLines: true,
    transformHeader: h => h.replace(/"/g, '').trim(),
    transform: v => v.replace(/"/g, '').trim(),
    complete: ({ data }) => {
      const vars = {};
      Object.keys(data[0] || {}).forEach(h => vars[h] = []);
      data.forEach(r => {
        Object.entries(r).forEach(([h, v]) => {
          if (v && !vars[h].includes(v)) vars[h].push(v);
        });
      });
      buildSelectors(vars);
    }
  });

  function buildSelectors(vars) {
    const container = document.getElementById('selectors');
    container.innerHTML = '';
    Object.entries(vars).forEach(([key, values]) => {
      const label = document.createElement('label');
      label.textContent = key;
      container.appendChild(label);

      const select = document.createElement('select');
      select.setAttribute('multiple', true);
      select.setAttribute('data-column', key);
      values.forEach(value => {
        const option = document.createElement('option');
        option.textContent = value;
        select.appendChild(option);
      });
      container.appendChild(select);

      // Bot√≥n "Quiero otra opci√≥n"
      const addBtn = document.createElement('button');
      addBtn.textContent = 'Quiero otra opci√≥n';
      addBtn.className = 'add-btn';
      addBtn.onclick = () => {
        inputWrapper.style.display = 'block';
        input.focus();
      };
      container.appendChild(addBtn);

      const inputWrapper = document.createElement('div');
      inputWrapper.className = 'new-option-input-wrapper';
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = `Otra opci√≥n para ${key}`;
      input.addEventListener('change', () => {
        const newValue = input.value.trim();
        if (newValue) {
          // Agrega al select
          const newOption = document.createElement('option');
          newOption.textContent = newValue;
          newOption.selected = true;
          select.appendChild(newOption);

          // Escribe en Google Sheets
          fetch(scriptURL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ column: key, value: newValue })
          });

          // Limpia
          input.value = '';
          inputWrapper.style.display = 'none';
        }
      });
      inputWrapper.appendChild(input);
      container.appendChild(inputWrapper);
    });
  }

  function buildPrompt() {
    const selects = document.querySelectorAll('#selectors select');
    const selections = [];
    selects.forEach(sel => {
      const selected = Array.from(sel.selectedOptions).map(o => o.textContent);
      if (selected.length) selections.push(...selected);
    });

    const iw = document.getElementById('iw').value.trim();
    const sref = document.getElementById('sref').value.trim();
    const oref = document.getElementById('oref').value.trim();
    const mood = document.getElementById('moodboard').value.trim();
    const params = Array.from(document.getElementById('params').selectedOptions).map(o => o.value);

    let prompt = selections.join(', ');
    if (iw) prompt += ` --iw ${iw}`;
    if (sref) prompt += ` --sref ${sref}`;
    if (oref) prompt += ` --oref ${oref}`;
    if (mood) prompt += ` --p ${mood}`;
    if (params.length) prompt += ' ' + params.join(' ');

    document.getElementById('output').textContent = prompt;
    document.getElementById('outputText').value = prompt;
  }

  function copyPromptAndSaveToSeparateSheet() {
    const prompt = document.getElementById('outputText').value;
    navigator.clipboard.writeText(prompt);
    fetch(scriptURL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prompt: prompt,
        timestamp: new Date().toISOString()
      })
    });
  }
</script>

</body>
</html>
