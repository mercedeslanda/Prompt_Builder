<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Prompts Urbanal√≠tica</title>
  <style>
    body { font-family: sans-serif; margin: 40px; max-width: 800px; }
    select, input[type="text"], textarea { width: 100%; margin-bottom: 12px; padding: 6px; font-size: 1rem; }
    button { margin-top: 10px; padding: 10px; font-size: 1rem; cursor: pointer; }
    .preview-container img { max-width: 120px; margin: 4px; display: inline-block; }
    .selector-block { margin-bottom: 20px; }
    .add-option { display: flex; margin-top: 4px; }
    .add-option input { flex: 1; margin-right: 6px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>

  <h1>Imaginar el Futuro del Territorio a 25 a√±os</h1>
  <p>Generador de Prompts __ URBANAL√çTICA</p>

  <!-- Imagen gu√≠a -->
  <label for="iw">üñºÔ∏è Imagen gu√≠a. (<code>--iw 100</code>)</label>
  <input type="text" id="iw" placeholder="Pega enlaces separados por espacio o coma">
  <div id="preview_iw" class="preview-container"></div>

  <!-- Zona de selectores din√°micos -->
  <div id="selectors"></div>
  <hr>

  <!-- Moodboards -->
  <label for="moodboard">üé® Moodboards. (<code>--p</code>)</label>
  <input type="text" id="moodboard" placeholder="--p d19hjfk">

  <hr>

  <!-- √Årea de generaci√≥n y guardado -->
  <button onclick="buildPrompt()">üîÅ Generar Prompt</button>
  <button onclick="copyAndSavePrompt()">üìã Copiar + Guardar Prompt</button>

  <label for="output">Prompt generado (editable):</label>
  <textarea id="output" rows="4" placeholder="Aqu√≠ aparece tu prompt..."></textarea>

  <script>
    const SHEET_URL_ADD_OPTION = 'https://script.google.com/a/macros/urbanalitica.com/s/AKfycbxlWowODLgms93HWLeL8v181a-L3RxM0qcohmoM1vO7FOY8Zqy8e_4Q_g8lOxOIS1BTPg/exec';
    const SHEET_URL_SAVE_PROMPT = 'https://script.google.com/macros/library/d/1nsMORaQ4tU2F5qZjZ1rihCVvXpLvwl4IObmx_LUteXASTCvxwT4rJhNk/1';

    function normalizeId(text) {
      return text.normalize('NFD')
                 .replace(/[\u0300-\u036f]/g, '')
                 .replace(/[^a-zA-Z0-9]+/g, '_')
                 .replace(/^_|_$/g, '')
                 .toLowerCase();
    }

    function buildSelectors(vars) {
      const container = document.getElementById('selectors');
      container.innerHTML = '';
      Object.entries(vars).forEach(([hdr, opts]) => {
        const id = normalizeId(hdr);
        const block = document.createElement('div');
        block.className = 'selector-block';
        // label
        const lbl = document.createElement('label');
        lbl.htmlFor = id;
        lbl.innerText = hdr;
        block.appendChild(lbl);
        // select
        const sel = document.createElement('select');
        sel.id = id;
        sel.multiple = true;
        opts.forEach(v => {
          const o = document.createElement('option');
          o.value = v;
          o.innerText = v;
          sel.appendChild(o);
        });
        block.appendChild(sel);
        // add new option
        const addOptDiv = document.createElement('div');
        addOptDiv.className = 'add-option';
        addOptDiv.innerHTML = `
          <input type="text" id="new_${id}" placeholder="Agregar opci√≥n a ${hdr}...">
          <button type="button" onclick="addOption('${id}', document.getElementById('new_${id}').value)">+ A√±adir</button>
        `;
        block.appendChild(addOptDiv);
        container.appendChild(block);
      });
    }

    function getSelected(id, sep = ' ') {
      const s = document.getElementById(id);
      return s ? Array.from(s.selectedOptions).map(o => o.value).join(sep) : '';
    }

    function setupPreview(id) {
      const inp = document.getElementById(id);
      const container = document.getElementById('preview_' + id);
      inp.addEventListener('input', () => {
        const urls = inp.value.split(/[\s,]+/).map(u => u.trim()).filter(u => u);
        container.innerHTML = '';
        urls.forEach(u => {
          const img = document.createElement('img'); img.src = u;
          img.onerror = () => img.remove();
          container.appendChild(img);
        });
      });
    }

    function addOption(selectorId, value) {
      if (!value) return;
      fetch(SHEET_URL_ADD_OPTION, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ header: selectorId, value })
      })
        .then(res => res.json())
        .then(() => {
          const sel = document.getElementById(selectorId);
          const opt = document.createElement('option');
          opt.value = value;
          opt.innerText = value;
          sel.appendChild(opt);
          document.getElementById('new_' + selectorId).value = '';
        })
        .catch(console.error);
    }

    function buildPrompt() {
      const parts = [];
      ['iw','sref','oref'].forEach(id => {
        const txt = document.getElementById(id).value.trim();
        if (txt) txt.split(/[\s,]+/).filter(u => u).forEach(u => parts.push(u));
      });
      document.querySelectorAll('#selectors select').forEach(sel => {
        const v = getSelected(sel.id, ' ');
        if (v) parts.push(v);
      });
      const mood = document.getElementById('moodboard').value.trim();
      if (mood) parts.push(mood);
      document.getElementById('output').value = parts.join(' ');
    }

    function copyAndSavePrompt() {
      const promptText = document.getElementById('output').value;
      navigator.clipboard.writeText(promptText).catch(console.error);
      fetch(SHEET_URL_SAVE_PROMPT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: promptText })
      }).catch(console.error);
      alert('‚úÖ Prompt copiado y guardado');
    }

    ['iw','sref','oref'].forEach(setupPreview);

    window.addEventListener('DOMContentLoaded', () => {
      const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR6s7kqLZw_q-qATqMs1-5oKdDddH2IJ-oXWNSVuT9XUGSQjkwNWPYx-XLv8O1FcVEiEr28ifZ-WDGM/pub?gid=0&single=true&output=csv';
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        transformHeader: h => h.replace(/"/g, '').trim(),
        transform: v => v.replace(/"/g, '').trim(),
        complete: ({ data, meta }) => {
          console.log('CSV headers:', meta.fields);
          console.log('CSV rows:', data);
          if (!data.length) {
            alert('CSV malformado o ruta incorrecta');
            return;
          }
          const vars = {};
          // Inicializar arrays para cada header encontrado
          meta.fields.forEach(hdr => vars[hdr] = []);
          data.forEach(row => {
            meta.fields.forEach(hdr => {
              const v = row[hdr];
              if (v && !vars[hdr].includes(v)) vars[hdr].push(v);
            });
          });
          console.log('Parsed selectors:', vars);
          buildSelectors(vars);
        },
        error: err => {
          console.error('Papa.parse error:', err);
          alert('Error cargando CSV, revisa consola');
        }
      });
          const vars = {};
          Object.keys(data[0]).forEach(h => vars[h] = []);
          data.forEach(row => Object.entries(row).forEach(([h, v]) => {
            if (v && !vars[h].includes(v)) vars[h].push(v);
          }));
          buildSelectors(vars);
        },
        error: err => {
          console.error(err);
          alert('Error cargando CSV');
        }
      });
    });
  </script>
</body>
</html>
